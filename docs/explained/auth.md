# ğŸŒŒ Authentication & User State Documentation

This document explains how the authentication system and global user state management are implemented in **stars.guide**. It serves as a reference for maintaining the "Atomic User" architecture.

---

## ğŸ—ï¸ Architecture Overview

The system uses a three-layer approach to ensure security, performance, and ease of use:

1.  **Backend (Convex & @convex-dev/auth)**: Handles the "Heavy Lifting" â€” OAuth handshakes, password hashing, session management, and the source-of-truth database.
2.  **Global Store (Zustand)**: Acts as a high-speed "Cache" for the frontend. Components read from this store to avoid redundant database round-trips.
3.  **Sync Layer (React & UserSync)**: The bridge exactly between Convex and Zustand, ensuring the store is always reactive and up-to-date.

---

## 1. Backend: Convex Setup

### ğŸ—„ï¸ Schema (`convex/schema.ts`)
We use the **"Atomic User"** strategy. Instead of spreading user data across many tables, we keep all core identity, billing, and astronomical data in a single `users` table.

- **`authTables`**: Injected at the top of the schema to provide standard `sessions`, `accounts`, and `verificationTokens`.
- **`users` Table**: Extended with custom fields:
    - `role`: Admin/User roles.
    - `tier`: Free/Pro/Stellar subscription levels.
    - `preferences`: User-specific UI/Notification settings.
    - `birthData`: The source for all astrological calculations (Phase 4).

### ğŸ›¡ï¸ Auth Configuration (`convex/auth.ts`)
This file configures the `@convex-dev/auth` server.

- **Providers**: Configured for Google, Apple, GitHub, and Password (Email).
- **`createOrUpdateUser` Hook**: This is the "Brain" of user creation. When a user first signs in:
    1.  The hook intercepts the profile.
    2.  It initializes the user with default values (Free tier, default preferences).
    3.  It ensures the user is securely stored in the `users` table.

### ğŸ”‘ Environment Variables
- `AUTH_SECRET`: Used for cookie signing.
- `JWT_PRIVATE_KEY` & `JWKS`: RSA keys generated by the Convex Auth CLI to sign/verify JWTs for the backend.

---

## 2. Frontend: User State Management

### ğŸ§  Zustand Store (`src/store/use-user-store.ts`)
The store provides a centralized way to check user status without prop-drilling or repetitive `useQuery` calls.

**Key States:**
- `user`: The full user document from Convex.
- `isLoading`: Tracks if we are still fetching the initial user data.

**Computed Helpers:**
- `isAuthenticated()`: `true` if a user object exists.
- `needsOnboarding()`: `true` if the user is logged in but hasn't completed birth data entry.
- `isPremium()`: Checks if the user's tier is not "free".

### ğŸ”„ UserSync (`src/components/providers/user-sync.tsx`)
Because Zustand is not inherently reactive to Convex's real-time updates, we use this logic-only component.

- It sits in the `RootLayout`.
- It performs a `useQuery(api.users.current)`.
- Whenever the Convex data changes, it calls `setUser()` in the Zustand store.
- **This ensures that if a user upgrades to Pro, the entire UI updates instantly without a refresh.**

---

## 3. Route Protection & Middleware

### ğŸš¦ Middleware (`src/middleware.ts`)
We use Convex's built-in Next.js middleware for efficient protection.

- **Public Routes**: `/`, `/sign-in`, `/sign-up`, `/forgot-password`.
- **Protected Routes**: Everything else.
- **Auto-Redirect**: If an unauthenticated user hits a protected route, they are seamlessly sent to `/sign-in`.

---

## 4. UI Implementation

### ğŸ­ Route Group `(auth)`
Located at `src/app/(auth)/`, this group shares a visually stunning background layout (`layout.tsx`) featuring:
- **Shooting Stars** (animated canvas).
- **Twinkling Stars** (ambient animation).
- **Glassmorphism** cards for the login/signup forms.

### ğŸ”‘ Navbar Integration
The `Navbar` uses the `useUserStore` to decide what to show in the top right:
- **Guest**: A "Sign In" icon button.
- **Authenticated**: A **User Avatar** that opens a dropdown menu (Dashboard, Settings, Sign Out).

---

## ğŸ› ï¸ How to...

### Add a new field to the User?
1.  Update `convex/schema.ts` with the new field.
2.  Update the `createOrUpdateUser` hook in `convex/auth.ts` to provide a default value.
3.  The field will automatically appear in `useUserStore().user` across the app.

### Force Onboarding?
The UI logic (likely in a `Dashboard` component) should check:
```tsx
const { needsOnboarding } = useUserStore();
if (needsOnboarding()) router.push("/onboarding");
```

---

*This system is designed for scale. Treat the `users` table as sacredâ€”it is the compass for the entire stars.guide experience.*
